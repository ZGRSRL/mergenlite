name: MergenLite CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  # -----------------------------------------------------------------------
  # Backend: lint + import check
  # -----------------------------------------------------------------------
  backend:
    name: Backend (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mergen/api

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install alembic pydantic-settings psycopg2-binary pgvector
          pip install ruff

      - name: Lint with ruff
        run: ruff check app/ --select=E,W,F --ignore=E501

      - name: Verify model imports
        run: python -c "from app.models import Opportunity, Hotel, VectorChunk; print('Models OK')"

      - name: Verify config loads
        run: python -c "from app.config import settings; print('Config OK, env:', settings.env)"

  # -----------------------------------------------------------------------
  # Frontend: build check
  # -----------------------------------------------------------------------
  frontend:
    name: Frontend (React/Vite)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit || true

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: http://localhost:8000

  # -----------------------------------------------------------------------
  # Docker: build + health check
  # -----------------------------------------------------------------------
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker images
        run: docker compose build --no-cache

      - name: Start services
        run: |
          docker compose up -d
          # Wait for health
          echo "Waiting for services..."
          sleep 15

      - name: Check backend health
        run: |
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s http://localhost:8000/health | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))" 2>/dev/null)
            if [ "$STATUS" = "healthy" ] || [ "$STATUS" = "ok" ]; then
              echo "Backend healthy ✓"
              exit 0
            fi
            echo "Attempt $i: status=$STATUS, retrying..."
            sleep 5
          done
          echo "Backend health check failed"
          docker compose logs backend
          exit 1

      - name: Check frontend
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Frontend OK ✓"
          else
            echo "Frontend returned $HTTP_CODE"
            docker compose logs frontend
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: docker compose down -v
